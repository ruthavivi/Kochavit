unit TipulReport;

interface

uses
  Windows, Messages, SysUtils, Variants, Classes, Graphics, Controls, Forms,
  Dialogs, GnrlReport, Menus, ImgList, ActnList, ComCtrls, StdCtrls,
  Buttons, ExtCtrls, Grids, DBGrids, DBCtrls, ToolWin, DB, DBTables, edbcomps,
  StdActns, DBActns;


type
  TfrmTipulReport = class(TfrmGnrlReport)
    Splitter1: TSplitter;
    Panel2: TPanel;
    DBGrid1: TDBGrid;
    edRemark: TDBMemo;
    dsDtl: TDataSource;
    N5: TMenuItem;
    acMail: TAction;
    procedure DBGridTitleClick(Column: TColumn);
    procedure FormCreate(Sender: TObject);
    procedure FormClose(Sender: TObject; var Action: TCloseAction);
    procedure acPrintExecute(Sender: TObject);
    procedure acStatisticExecute(Sender: TObject);
    procedure acExcelExecute(Sender: TObject);
    procedure acMailExecute(Sender: TObject);
  private
    procedure SetStatusBar;
    procedure GnrlPrints(pDocName, pFunc: String; pCopyNum: Integer);
  public
  end;

var
  frmTipulReport: TfrmTipulReport;

implementation
{$R *.dfm}
uses
   TipulFilterDM, TipulRprtSlctDlg, TipulSpssSlctDlg, LogErrorUtil,
   OpenToPrint, DocUtils;

procedure TfrmTipulReport.FormCreate(Sender: TObject);
begin
  inherited;
  MarkIndexColumn('DateDone');
  SetStatusBar;
end;

procedure TfrmTipulReport.SetStatusBar;
var
  Procent: String;
begin
  if (StrToInt(dmTipulFilter.TotalRec) = 0) then
    Procent := '0'
  else
    Procent := FormatFloat('#.##', StrToInt(dmTipulFilter.TotalSelectRec) /
          StrToInt(dmTipulFilter.TotalRec) * 100);
  StatusBar1.Panels[0].Text := ' סה"כ טיפולים בדו"ח: ' + dmTipulFilter.TotalSelectRec +
      ' מתוך ' + dmTipulFilter.TotalRec + ' שהם: ' + Procent + '%';
end;

procedure TfrmTipulReport.DBGridTitleClick(Column: TColumn);
begin
  inherited;
  dmTipulFilter.SqlState.Order := GetOrders(Column);
  dmTipulFilter.ReOpen;
  MarkIndexColumn(Column.FieldName);
end;

procedure TfrmTipulReport.acPrintExecute(Sender: TObject);
begin
  inherited;
  frmTipulRprtSlctDlg := TfrmTipulRprtSlctDlg.Create(Self);
  frmTipulRprtSlctDlg.Show;
end;

procedure TfrmTipulReport.acStatisticExecute(Sender: TObject);
begin
  inherited;
  frmTipulSpssSlctDlg := TfrmTipulSpssSlctDlg.Create(Self);
  frmTipulSpssSlctDlg.Show;
end;

procedure TfrmTipulReport.acExcelExecute(Sender: TObject);
begin
  inherited;
  SaveExcel(dmTipulFilter.qrFilter);
end;

procedure TfrmTipulReport.acMailExecute(Sender: TObject);
var
  DocName, CopyNum: OleVariant;
  Func: String;
begin
  inherited;
  frmOpenToPrint := TfrmOpenToPrint.Create(self);
  with frmOpenToPrint do
  begin
    cbFilter.Checked := False;
    DirectoryListBox.Directory := ExtractFilePath(Application.ExeName) + 'Docs\Car';
    Edit.Text := '';
    if (ShowModal = mrOK) then
    begin
      DocName := DirectoryListBox.Directory + '\' + Edit.Text;
      Func := btnPress;
      CopyNum := SpinEdit.Value;
      GnrlPrints(DocName, Func, CopyNum);
    end;
  end;
end;

procedure TfrmTipulReport.GnrlPrints(pDocName, pFunc: String;
  pCopyNum: Integer);
var
  Subject: String;
  OneDoc: TDocUtils;
begin
  Subject := 'הודעה מהקצין רכב';
  Screen.Cursor := crHourGlass;
  dmTipulFilter.qrFilter.DisableControls;
  dmTipulFilter.qrFilter.First;
  OneDoc := TDocUtils.Create(pFunc, pCopyNum, False, Subject, '', '', pDocName);
  try
    while not dmTipulFilter.qrFilter.Eof do
    begin
      OneDoc.Email := dmTipulFilter.qrFilter.FieldByName('Email').AsString;
      OneDoc.SendDoc(dmTipulFilter.qrFilter,

//      dmClientFilter.qrFilter, nil, nil);
      dmTipulFilter.qrFilter.Next;
    end;
  finally
    dmTipulFilter.qrFilter.EnableControls;
    Screen.Cursor := crDefault;
  end;
end;

procedure TfrmTipulReport.FormClose(Sender: TObject;
  var Action: TCloseAction);
begin
  dmTipulFilter.qrFilter.Close;
  inherited;
  frmTipulReport := nil;
end;

end.
